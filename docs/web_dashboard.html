<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Greenhouse Dashboard (MQTT over WebSockets)</title>
  <style>
    :root{--gap:8px;--card-pad:8px;--muted:#666}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:10px;background:#f6f7f8;color:#111}
    h1,h2{margin:6px 0 10px 0;font-size:1.1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--gap)}
    .card{border:1px solid #e3e6e8;padding:var(--card-pad);border-radius:6px;background:#fff;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{padding:6px 10px;border-radius:6px}
    .connected{background:#e6ffed;border:1px solid #b7f0c3}
    .disconnected{background:#fff2f2;border:1px solid #f0b7b7}
    #messages{height:260px;overflow:auto;background:#fff;padding:12px;border-radius:6px;border:1px solid #ddd}
    .msg{padding:6px 8px;border-bottom:1px solid #eee}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,button,select,textarea{padding:6px;border-radius:6px;border:1px solid #ccc}
    button{cursor:pointer}
    label{display:block;font-size:13px;margin-bottom:6px}
    table{border-collapse:collapse;width:100%;font-size:0.95rem}
    th,td{border:1px solid #eef0f1;padding:6px;text-align:left}
    .small{font-size:0.85rem;color:var(--muted)}
    ul#relaysList{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;padding-left:0;list-style:none;margin:0}
    ul#relaysList li{background:#fbfbfb;padding:6px;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <header>
    <h2>Invernadero — Dashboard</h2>
    <div id="conn" class="status disconnected">Desconectado</div>
  </header>

  <div class="card">
    <label>Broker WebSocket URL</label>
    <input id="brokerUrl" value="wss://broker.hivemq.com:8884/mqtt" style="width:60%" />
    <label style="margin-top:8px">Device ID (para enviar comandos)</label>
    <input id="deviceId" placeholder="ej: greenhouse-01" />
    <div class="controls">
      <button id="btnConnect">Conectar</button>
      <button id="btnSubscribeAll">Suscribir a sensores</button>
      <button id="btnClear">Limpiar mensajes</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Relays</h3>
      <ul id="relaysList"></ul>
    </div>

    <div class="card">
      <h3>Luces</h3>
      <div class="row">
        <div id="lightsState">Estado: <strong>—</strong></div>
        <button id="toggleLights">Alternar</button>
        <div class="small">Min diario: <input id="minHours" size=4 value="12.0"> h</div>
        <div class="small">Acumulado hoy: <span id="accum">0.00</span> h</div>
      </div>
    </div>

    <div class="card">
      <h3>Temperatura</h3>
      <div>Interior: <span id="inTemp">—</span> °C, <span id="inHum">—</span>%</div>
      <div>Exterior: <span id="outTemp">—</span> °C, <span id="outHum">—</span>%</div>
    </div>

    <div class="card">
      <h3>Termostato</h3>
      <div class="row"><div>Temp actual: <strong id="tTemp">—</strong> °C</div>
      <div class="small">Setpoint: <input id="tSet" size=4 value="23.0"> °C</div>
      <div class="small">Hyst: <input id="tHyst" size=3 value="0.5"> °C</div>
      <button id="saveTherm">Guardar</button></div>
    </div>

    <div class="card">
      <h3>Automatización</h3>
      <div class="small">Riego (veces/duración/inicio): <input id="irCount" size=2 value="3"> / <input id="irDur" size=3 value="60"> s / <input id="irStart" size=2 value="6">h <button id="saveIrr">Guardar</button></div>
      <div style="margin-top:8px">Tiempos CSV (HH:MM): <input id="irTimes" size=20 value="06:00,12:00,18:00"> <button id="setIrrTimes">Fijar tiempos</button></div>
    </div>

    <div class="card">
      <h3>Historial de luz (mock)</h3>
      <div class="small">Últimos días</div>
      <table id="historyTbl" style="margin-top:8px">
        <thead><tr><th>Fecha</th><th>Horas</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Horarios</h3>
      <table id="schedTbl"><thead><tr><th>#</th><th>CH</th><th>Hora</th><th>Min</th><th>Acción</th><th>Activado</th><th>Días</th></tr></thead><tbody></tbody></table>
      <div style="margin-top:8px">Agregar: CH <select id="addCh"><option value="2">2 (Luces)</option><option value="3">3 (Riego)</option></select> Hora <input id="addH" size=2> Min <input id="addM" size=2> Acción <select id="addOn"><option value="1">Encender</option><option value="0">Apagar</option></select> <button id="addSched">Añadir</button></div>
    </div>
  </div>

  <div class="card">
    <h3>Mensajes (suscritos)</h3>
    <div id="messages"></div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const connEl = document.getElementById('conn');
    const brokerInput = document.getElementById('brokerUrl');
    const btnConnect = document.getElementById('btnConnect');
    const messagesEl = document.getElementById('messages');
    const deviceIdInput = document.getElementById('deviceId');
    const btnSendCmd = document.getElementById('btnSendCmd');
    const btnSendRetained = document.getElementById('btnSendRetained');
    const topicExample = document.getElementById('topicExample');

    let client = null;

    function setStatus(connected){
      connEl.textContent = connected ? 'Conectado' : 'Desconectado';
      connEl.className = 'status ' + (connected ? 'connected' : 'disconnected');
    }

    function logMsg(t, payload){
      const d = document.createElement('div');
      d.className = 'msg';
      const time = new Date().toLocaleTimeString();
      d.innerHTML = `<strong>${t}</strong> <span style="color:#666">[${time}]</span><pre style="margin:6px 0 0 0">${escapeHtml(payload)}</pre>`;
      messagesEl.prepend(d);
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    btnConnect.onclick = ()=>{
      if (client && client.connected) { client.end(true); client = null; setStatus(false); btnConnect.textContent='Conectar'; return; }
      const broker = brokerInput.value.trim();
      if (!broker) return alert('Introduce broker WebSocket URL');
      // clientId random
      const clientId = 'webclient_' + Math.random().toString(16).substr(2,8);
      client = mqtt.connect(broker, {clientId, keepalive:30, reconnectPeriod:2000, connectTimeout:4000});

      client.on('connect', ()=>{ setStatus(true); btnConnect.textContent='Desconectar'; logMsg('SYSTEM','Conectado al broker ' + broker); });
      client.on('reconnect', ()=> logMsg('SYSTEM','Reintentando conexión...'));
      client.on('offline', ()=> setStatus(false));
      client.on('error', (err)=> { logMsg('ERROR', String(err)); });
      client.on('close', ()=> { setStatus(false); logMsg('SYSTEM','Conexión cerrada'); });
      client.on('message', (topic, message)=>{ try{ const s = message.toString(); logMsg(topic, s); try{ handleSensorMessage(topic, JSON.parse(s)); }catch(e){ } }catch(e){ logMsg('PARSE_ERROR', message.toString()); } });
    };

    document.getElementById('btnSubscribeAll').onclick = ()=>{
      if (!client || !client.connected) return alert('Conéctate primero al broker');
      const topic = 'greenhouse/+/sensor';
      client.subscribe(topic, {qos:0}, (err, granted)=>{ if (err) logMsg('ERROR', String(err)); else logMsg('SYSTEM', 'Suscrito a ' + topic); });
    };

    document.getElementById('btnClear').onclick = ()=> messagesEl.innerHTML = '';

    btnSendCmd.onclick = ()=>{
      if (!client || !client.connected) return alert('Conéctate primero');
      const deviceId = deviceIdInput.value.trim();
      if (!deviceId) return alert('Introduce Device ID');
      const topic = `greenhouse/${deviceId}/cmd`;
      const payload = document.getElementById('cmdPayload').value;
      try{ JSON.parse(payload); } catch(e){ if(!confirm('Payload no es JSON válido. Enviar de todas formas?')) return; }
      client.publish(topic, payload, {qos:0, retain:false}, (err)=>{ if(err) logMsg('ERROR', String(err)); else logMsg('SENT', `Topic: ${topic}
${payload}`); });
    };

    btnSendRetained.onclick = ()=>{
      if (!client || !client.connected) return alert('Conéctate primero');
      const deviceId = deviceIdInput.value.trim();
      if (!deviceId) return alert('Introduce Device ID');
      const topic = `greenhouse/${deviceId}/cmd`;
      const payload = document.getElementById('cmdPayload').value;
      client.publish(topic, payload, {qos:1, retain:true}, (err)=>{ if(err) logMsg('ERROR', String(err)); else logMsg('SENT', `Retained: ${topic}
${payload}`); });
    };

    // Example topic preview
    setInterval(()=>{
      const id = deviceIdInput.value.trim() || '<device-id>';
      topicExample.textContent = `greenhouse/${id}/cmd`;
    }, 500);

    // UI helpers and mock rendering
    const relaysState = [false,false,false,false,false,false];
    function renderRelays(){ const ul = document.getElementById('relaysList'); if(!ul) return; ul.innerHTML=''; for(let i=0;i<6;i++){ let li=document.createElement('li'); li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.innerHTML = `<span>CH${i+1}: <strong>${relaysState[i]? 'ENCENDIDO':'APAGADO'}</strong></span>`; let btn=document.createElement('button'); btn.textContent='Alternar'; btn.onclick=(()=>{ const idx=i; return ()=>{ sendToggleRelay(idx+1); }; })(); li.appendChild(btn); ul.appendChild(li);} }
    function updateTemps(obj){ if(obj.inTemp!==undefined) document.getElementById('inTemp').textContent = obj.inTemp; if(obj.inHum!==undefined) document.getElementById('inHum').textContent = obj.inHum; if(obj.outTemp!==undefined) document.getElementById('outTemp').textContent = obj.outTemp; if(obj.outHum!==undefined) document.getElementById('outHum').textContent = obj.outHum; if(obj.lightsState!==undefined) document.getElementById('lightsState').querySelector('strong').textContent = obj.lightsState? 'ENCENDIDO':'APAGADO'; if(obj.accumHours!==undefined) document.getElementById('accum').textContent = Number(obj.accumHours).toFixed(2); }
    function sendToggleRelay(ch){ if(!client||!client.connected) return alert('Conéctate'); const deviceId = deviceIdInput.value.trim(); if(!deviceId) return alert('Device ID'); const topic=`greenhouse/${deviceId}/cmd`; const payload=JSON.stringify({cmd:'toggle_relay',relay:ch}); client.publish(topic,payload); logMsg('SENT',payload); }
    function sendThermostat(setpt,hyst){ if(!client||!client.connected) return alert('Conéctate'); const deviceId = deviceIdInput.value.trim(); if(!deviceId) return alert('Device ID'); const topic=`greenhouse/${deviceId}/cmd`; const payload=JSON.stringify({cmd:'set_thermostat',setpoint:setpt,hyst:hyst}); client.publish(topic,payload); logMsg('SENT',payload); }
    function sendIrrTimes(times){ if(!client||!client.connected) return alert('Conéctate'); const deviceId = deviceIdInput.value.trim(); if(!deviceId) return alert('Device ID'); const topic=`greenhouse/${deviceId}/cmd`; const payload=JSON.stringify({cmd:'set_irrigation',times:times}); client.publish(topic,payload); logMsg('SENT',payload); }

    document.getElementById('toggleLights').addEventListener('click', ()=> sendToggleRelay(2));
    document.getElementById('saveTherm').addEventListener('click', ()=>{ const s=parseFloat(document.getElementById('tSet').value); const h=parseFloat(document.getElementById('tHyst').value); sendThermostat(s,h); });
    document.getElementById('setIrrTimes').addEventListener('click', ()=>{ sendIrrTimes(document.getElementById('irTimes').value); });

    // handle incoming sensor payloads
    function handleSensorMessage(topic,obj){
      // topic: greenhouse/<id>/sensor
      if(obj.relays) { for(let i=0;i<Math.min(obj.relays.length,6);i++){ relaysState[i]=!!obj.relays[i]; } renderRelays(); }
      updateTemps(obj);
      // history and schedules support
      if(obj.history && Array.isArray(obj.history)){
        const tb = document.querySelector('#historyTbl tbody'); if(tb){ tb.innerHTML=''; obj.history.forEach(h=>{ let r=document.createElement('tr'); r.innerHTML=`<td>${h.date}</td><td>${Number(h.hours).toFixed(2)}</td>`; tb.appendChild(r); }); }
      }
      if(obj.schedules && Array.isArray(obj.schedules)){
        const tb = document.querySelector('#schedTbl tbody'); if(tb){ tb.innerHTML=''; obj.schedules.forEach((s,i)=>{ let r=document.createElement('tr'); r.innerHTML=`<td>${i}</td><td>${s.ch}</td><td>${s.hour}</td><td>${s.minute}</td><td>${s.on? 'Encender':'Apagar'}</td><td>${s.enabled? 'Sí':'No'}</td><td>${s.days}</td>`; tb.appendChild(r); }); }
      }
    }

    // initial render
    renderRelays();

    // Auto connect on page load (optional)
    // btnConnect.click();
  </script>
</body>
</html>
